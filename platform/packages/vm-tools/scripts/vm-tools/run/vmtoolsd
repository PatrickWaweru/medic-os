#!/bin/sh

source '/boot/include/utility'

find_ntp_server()
{
  echo 'pool.ntp.org'
}

detect_vmware()
{
  dmesg | grep -i '^DMI: VMware' &>/dev/null
  return "$?"
}

start()
{
  local self="`realpath "$0"`"
  local base="`dirname -- "$self"`"

  source "$base/../env" &&
  merge_environment /srv || return 255

  if ! detect_vmware; then
    exec nohup ntpd -ndp "`find_ntp_server`" \
      >> "$PACKAGE_STORAGE/ntpd/logs/startup.log" 2>&1
  fi

  # For OpenSSL's libcrypto and libssl
  prepend_paths /srv/software/medic-core/current/default

  modprobe -a \
    vmw_vmci vmw_vsock_vmci_transport vmxnet3 vmw_balloon &&
  \
  exec vmtoolsd 2>&1 \
    | /boot/timestamp \
    >> "$PACKAGE_STORAGE/vmtoolsd/logs/startup.log"
}

start
exit "$?"

