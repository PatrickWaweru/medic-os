#!/bin/sh

source '/boot/include/utility'
source '/boot/include/hypervisor'

install()
{
  local is_update="$1"
  shift 1

  local self="`realpath "$0"`"
  local base="`dirname -- "$self"`"

  source "$base/env" &&
  merge_environment /srv || return 255

  local version="$PACKAGE_VERSION"
  local platform="`cat /etc/platform`"
  local couchdb_settings="$PACKAGE_SETTINGS/couchdb"
  local major_version="`echo "$version" | sed 's/\.[0-9]\+$//;'`"

  (cd "$PACKAGE_ROOT/../" &&
    rm -f default && ln -sf "$platform" default) &&
  \
  (cd "$PACKAGE_ROOT/../../" &&
    rm -f "v$major_version" &&
    ln -sf "v$version" "v$major_version" &&
    rm -f current && ln -sf v"$version" current) &&
  \
  mkdir -p /var/run/nginx &&
  \
  (cd "$PACKAGE_STORAGE/nginx/state" && \
    ln -sf ../logs logs) &&
  \
  chown -R couchdb:staff \
    "$couchdb_settings" "$PACKAGE_STORAGE/couchdb" &&
  \
  chown -R couchdb-lucene:staff \
    "$PACKAGE_STORAGE/couchdb-lucene" &&
  \
  chmod 0750 "$couchdb_settings" \
    "$PACKAGE_STORAGE/couchdb" "$PACKAGE_STORAGE/couchdb-lucene" &&
  \
  chmod 0700 \
    "$SERVICE_PASSWD_PATH" \
    "$couchdb_settings/private" \
    "$PACKAGE_SETTINGS/openssh/private" &&
  \
  if [ -z "$is_update" ]; then
    info 'Installing default CouchDB databases'
    install_default_couchdb_databases "$PACKAGE_ROOT" "$PACKAGE_STORAGE"
  fi &&
  \
  if [ ! -f "$couchdb_settings/local.ini" ]; then
    cp -a "$couchdb_settings/private/local.ini" "$couchdb_settings/"
  fi

  return "$?"
}

install_default_couchdb_databases()
{
  local package_root="$1"
  local storage_dir="$2"

  local src_dir="$package_root/share/couchdb/garden"
  local dst_dir="$storage_dir/couchdb/data"

  for path in "$src_dir"/*.couch; do

    local dst_path="$dst_dir/`basename -- "$path"`" \
      || return "$?"

    if ! [ -f "$dst_path" ]; then
      cp -a "$path" "$dst_path" && chown couchdb:couchdb "$dst_path" \
        || return "$?"
    fi
  done

  return 0
}

install "$@"
exit "$?"

